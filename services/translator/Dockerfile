# =============================================================================
# Dockerfile - Service Translator avec Support de Diarisation
# =============================================================================
# Utilise Python 3.11 pour compatibilit√© avec chatterbox-tts et pyannote.audio
#
# Build:
#   docker build -t meeshy-translator:latest .
#
# Run:
#   docker run -p 8002:8002 -p 5555:5555 \
#     -e ENABLE_DIARIZATION=true \
#     -e HF_TOKEN=your_token \
#     meeshy-translator:latest
# =============================================================================

FROM python:3.11-slim

LABEL maintainer="Meeshy Platform"
LABEL description="Translator Service avec support de transcription, traduction et diarisation"
LABEL python.version="3.11"
LABEL diarization.enabled="true"

# Variables d'environnement
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive \
    # Chemins des mod√®les ML
    MODELS_PATH=/app/models \
    HF_HOME=/app/models/huggingface \
    TRANSFORMERS_CACHE=/app/models/huggingface \
    # Configuration service
    PYTHONPATH=/app/src \
    TTS_MODEL=chatterbox \
    # Diarisation
    ENABLE_DIARIZATION=true

WORKDIR /app

# Installer d√©pendances syst√®me
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build tools
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    # Audio/video processing
    ffmpeg \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev \
    libsndfile1 \
    libsndfile1-dev \
    # R√©seau
    git \
    curl \
    # Nettoyage
    && rm -rf /var/lib/apt/lists/*

# Copier requirements
COPY requirements.txt requirements-optional.txt ./

# Installer d√©pendances Python principales
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Installer d√©pendances de diarisation (pyannote.audio + scikit-learn)
# Note: librosa est d√©j√† inclus via chatterbox-tts
RUN echo "üéØ Installation des d√©pendances de diarisation..." && \
    pip install --no-cache-dir pyannote.audio>=3.1.0 scikit-learn>=1.3.0 && \
    echo "‚úÖ D√©pendances de diarisation install√©es" || \
    echo "‚ö†Ô∏è  Installation de diarisation √©chou√©e - utilisation du fallback pitch clustering"

# V√©rifier l'installation pyannote.audio
RUN python -c "from pyannote.audio import Pipeline; print('‚úÖ pyannote.audio disponible pour diarisation pr√©cise')" || \
    echo "‚ÑπÔ∏è  pyannote.audio non disponible - fallback pitch clustering sera utilis√©"

# V√©rifier scikit-learn
RUN python -c "from sklearn.cluster import KMeans; print('‚úÖ scikit-learn disponible')" || \
    echo "‚ö†Ô∏è  scikit-learn non disponible - fonctionnalit√©s de clustering limit√©es"

# Copier le code source
COPY . .

# Cr√©er les r√©pertoires n√©cessaires
RUN mkdir -p \
    /app/models/huggingface \
    /app/models/whisper \
    /app/models/openvoice \
    /app/models/voice_cache \
    /app/uploads \
    /app/generated/audios \
    /app/embeddings/voices \
    /app/analytics_data \
    /app/logs

# Permissions
RUN chmod -R 755 /app && \
    chmod +x /app/src/main.py 2>/dev/null || true

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8002/health').raise_for_status()" || exit 1

# Exposer les ports
EXPOSE 8002 5555 5558

# Point d'entr√©e
CMD ["python", "-u", "src/main.py"]
