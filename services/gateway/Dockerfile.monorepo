# =============================================================================
# MEESHY GATEWAY - Fastify Service (Monorepo Build)
# Build context: Root of monorepo
# Usage: docker build -f services/gateway/Dockerfile.monorepo -t meeshy-gateway .
# =============================================================================
FROM node:22-alpine AS base

LABEL maintainer="Meeshy Development Team <dev@meeshy.me>" \
      description="Meeshy Gateway - Fastify API Service" \
      org.opencontainers.image.source="https://github.com/isopen-io/meeshy" \
      org.opencontainers.image.vendor="Meeshy"

ARG PNPM_VERSION=9.15.0

ENV NODE_ENV=production \
    PNPM_HOME="/pnpm" \
    PATH="/pnpm:$PATH"

# System setup
RUN apk add --no-cache \
        tini \
        curl \
        python3 \
        make \
        g++ \
        ffmpeg \
    && corepack enable pnpm \
    && corepack prepare pnpm@${PNPM_VERSION} --activate

# ===== DEPS STAGE =====
FROM base AS deps
WORKDIR /app

# Copy root workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy package.json files for all packages
COPY packages/shared/package.json ./packages/shared/
COPY services/gateway/package.json ./services/gateway/

# Install dependencies
RUN pnpm install --frozen-lockfile

# ===== BUILDER STAGE =====
FROM base AS builder
WORKDIR /app

# Copy dependencies
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/packages/shared/node_modules ./packages/shared/node_modules
COPY --from=deps /app/services/gateway/node_modules ./services/gateway/node_modules

# Copy source files
COPY packages/shared ./packages/shared
COPY services/gateway ./services/gateway
COPY pnpm-workspace.yaml ./

# Build shared package first
WORKDIR /app/packages/shared
RUN pnpm build

# Generate Prisma client
RUN npx prisma generate --schema=./prisma/schema.prisma || true

# Build gateway
WORKDIR /app/services/gateway
RUN pnpm build

# ===== RUNNER STAGE =====
FROM base AS runner
WORKDIR /app

ARG FASTIFY_PORT=3000
ARG FASTIFY_HOST=0.0.0.0
ARG LOG_LEVEL=info

ENV NODE_ENV=production \
    FASTIFY_PORT=${FASTIFY_PORT} \
    FASTIFY_HOST=${FASTIFY_HOST} \
    LOG_LEVEL=${LOG_LEVEL} \
    PORT=${FASTIFY_PORT}

# Create user
RUN addgroup -g 1001 -S nodejs \
    && adduser -u 1001 -S -G nodejs gateway \
    && mkdir -p /app/logs \
    && chown -R gateway:nodejs /app

# Copy built artifacts
COPY --from=builder --chown=gateway:nodejs /app/services/gateway/dist ./dist
COPY --from=builder --chown=gateway:nodejs /app/services/gateway/node_modules ./node_modules
COPY --from=builder --chown=gateway:nodejs /app/packages/shared/dist ./node_modules/@meeshy/shared/dist
COPY --from=builder --chown=gateway:nodejs /app/packages/shared/prisma ./node_modules/@meeshy/shared/prisma
COPY --from=builder --chown=gateway:nodejs /app/packages/shared/package.json ./node_modules/@meeshy/shared/

# Copy entrypoint (expects docker-entrypoint.sh to exist)
COPY --from=builder /app/services/gateway/docker-entrypoint.sh ./docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh || true

USER gateway

EXPOSE ${FASTIFY_PORT}

ENTRYPOINT ["/sbin/tini", "--"]

HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:${FASTIFY_PORT}/health || exit 1

CMD ["node", "dist/src/server.js"]
