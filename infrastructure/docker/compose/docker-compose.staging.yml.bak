# =============================================================================
# MEESHY - Docker Compose STAGING (*.staging.meeshy.me)
# =============================================================================
# Deployment: /opt/meeshy/staging/
# Isolation: Ports, volumes, domaines et réseau séparés de production
# Base: Configuration identique à production mais isolée pour tests
# =============================================================================

services:
  # ===========================================================================
  # TRAEFIK STAGING - Reverse Proxy sur ports alternatifs
  # ===========================================================================
  traefik-staging:
    image: traefik:v3.6
    container_name: meeshy-traefik-staging
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=meeshy-staging-network"
      - "--providers.docker.constraints=Label(`traefik.env`,`staging`)"
      - "--providers.file.filename=/config/dynamic.yaml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${CERTBOT_EMAIL:-admin@meeshy.me}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Redirection HTTPS désactivée temporairement (rate limit Let's Encrypt)
      # - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "8080:80"    # HTTP staging (port alternatif)
      - "8443:443"   # HTTPS staging (port alternatif)
    environment:
      - TRAEFIK_USERS=${TRAEFIK_USERS}
      - API_USERS=${API_USERS}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_staging_certs:/letsencrypt
      - ./config/dynamic.yaml:/config/dynamic.yaml:ro
    networks:
      - meeshy-staging-network
    labels:
      - "traefik.enable=true"
      - "traefik.env=staging"
      - "traefik.http.routers.traefik-staging.rule=Host(`traefik.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.traefik-staging.entrypoints=websecure"
      - "traefik.http.routers.traefik-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-staging.service=api@internal"
      - "traefik.http.routers.traefik-staging.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_USERS:-}"

  # ===========================================================================
  # DATABASE STAGING - MongoDB Replica Set
  # ===========================================================================
  database-staging:
    image: ${DATABASE_IMAGE:-mongo:8.0}
    container_name: meeshy-database-staging
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --noauth
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-meeshy}
    ports:
      - "27018:27017"  # Exposition externe pour debug/migration
    volumes:
      - database_staging_data:/data/db
      - database_staging_config:/data/configdb
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MongoDB Replica Set Init (one-shot)
  mongo-init-staging:
    image: ${DATABASE_IMAGE:-mongo:8.0}
    container_name: meeshy-mongo-init-staging
    depends_on:
      database-staging:
        condition: service_healthy
    networks:
      - meeshy-staging-network
    entrypoint: >
      mongosh --host database-staging:27017 --eval '
        try {
          const status = rs.status();
          print("Replica set already initialized, state: " + status.myState);
        } catch (e) {
          print("Initializing replica set...");
          rs.initiate({
            _id: "rs0",
            members: [{ _id: 0, host: "database-staging:27017" }]
          });
          print("Replica set initialized!");
        }
      '
    restart: "no"

  # ===========================================================================
  # NOSQLCLIENT STAGING - MongoDB Web UI
  # ===========================================================================
  nosqlclient-staging:
    image: mongoclient/mongoclient:latest
    container_name: meeshy-nosqlclient-staging
    restart: unless-stopped
    environment:
      MONGOCLIENT_DEFAULT_CONNECTION_URL: "mongodb://database-staging:27017/${MONGODB_DATABASE:-meeshy}?replicaSet=rs0&directConnection=true"
      ROOT_URL: "https://mongo.staging.${DOMAIN:-meeshy.me}"
      PORT: 3000
    depends_on:
      mongo-init-staging:
        condition: service_completed_successfully
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nosqlclient-staging.rule=Host(`mongo.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.nosqlclient-staging.entrypoints=websecure"
      - "traefik.http.routers.nosqlclient-staging.tls.certresolver=letsencrypt"
      - "traefik.http.services.nosqlclient-staging.loadbalancer.server.port=3000"
      - "traefik.http.routers.nosqlclient-staging.middlewares=mongo-auth"
      - "traefik.http.middlewares.mongo-auth.basicauth.users=${MONGO_USERS:-}"

  # ===========================================================================
  # REDIS STAGING
  # ===========================================================================
  redis-staging:
    image: redis:8-alpine
    container_name: meeshy-redis-staging
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"  # Port alternatif pour debug
    volumes:
      - redis_staging_data:/data
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # P3X REDIS UI STAGING
  # ===========================================================================
  p3x-redis-ui-staging:
    image: patrikx3/p3x-redis-ui:latest
    container_name: meeshy-p3x-redis-ui-staging
    restart: unless-stopped
    environment:
      - P3X_REDIS_UI_SETTINGS={"hostname":"redis-staging","port":6379,"password":"","database":0}
      - P3X_REDIS_UI_HTTP_PORT=7843
      - P3XRS_SETTINGS_PATH=/settings
    volumes:
      - redis_staging_ui_data:/settings
    depends_on:
      redis-staging:
        condition: service_healthy
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD-SHELL", "netstat -an | grep :7843 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.p3x-redis-staging.rule=Host(`redis.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.p3x-redis-staging.entrypoints=websecure"
      - "traefik.http.routers.p3x-redis-staging.tls.certresolver=letsencrypt"
      - "traefik.http.services.p3x-redis-staging.loadbalancer.server.port=7843"
      - "traefik.http.routers.p3x-redis-staging.middlewares=redis-auth"
      - "traefik.http.middlewares.redis-auth.basicauth.users=${REDIS_USERS:-}"

  # ===========================================================================
  # TRANSLATOR STAGING - ML Service
  # ===========================================================================
  translator-staging:
    image: ${TRANSLATOR_IMAGE:-isopen/meeshy-translator:latest}
    container_name: meeshy-translator-staging
    restart: unless-stopped
    environment:
      - DATABASE_TYPE=${DATABASE_TYPE:-MONGODB}
      - DATABASE_URL=mongodb://database-staging:27017/${MONGODB_DATABASE:-meeshy}?replicaSet=rs0&directConnection=true
      - REDIS_URL=redis://redis-staging:6379
      - PRISMA_SCHEMA_PATH=/workspace/shared/prisma/schema.prisma
      - PYTHONPATH=/workspace:/workspace/generated
      - PYTHONUNBUFFERED=1
      - NODE_ENV=staging
      - HF_HOME=/workspace/models
      - TRANSFORMERS_CACHE=/workspace/models
      - HUGGINGFACE_HUB_CACHE=/workspace/models
      - MAX_MESSAGE_LENGTH=10000
      - MAX_TEXT_LENGTH=100000
      - MAX_TRANSLATION_LENGTH=100000
      - MAX_TEXT_ATTACHMENT_THRESHOLD=100000
      - ENABLE_DIARIZATION=${ENABLE_DIARIZATION:-true}
    volumes:
      - models_staging_data:/workspace/models
    depends_on:
      mongo-init-staging:
        condition: service_completed_successfully
      redis-staging:
        condition: service_healthy
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      # Router HTTP temporaire
      - "traefik.http.routers.translator-staging-http.rule=Host(`ml.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.translator-staging-http.entrypoints=web"
      # Router HTTPS
      - "traefik.http.routers.translator-staging.rule=Host(`ml.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.translator-staging.entrypoints=websecure"
      - "traefik.http.routers.translator-staging.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.translator-staging.loadbalancer.server.port=8000"

  # ===========================================================================
  # GATEWAY STAGING - API Service
  # ===========================================================================
  gateway-staging:
    image: ${GATEWAY_IMAGE:-isopen/meeshy-gateway:latest}
    container_name: meeshy-gateway-staging
    restart: unless-stopped
    environment:
      - DATABASE_TYPE=${DATABASE_TYPE:-MONGODB}
      - DATABASE_URL=mongodb://database-staging:27017/${MONGODB_DATABASE:-meeshy}?replicaSet=rs0&directConnection=true
      - REDIS_URL=redis://redis-staging:6379
      - TRANSLATOR_URL=http://translator-staging:8000
      - ZMQ_PUSH_URL=tcp://translator-staging:5555
      - ZMQ_SUB_URL=tcp://translator-staging:5558
      - ZMQ_TRANSLATOR_HOST=translator-staging
      - ZMQ_TRANSLATOR_PUSH_PORT=5555
      - ZMQ_TRANSLATOR_SUB_PORT=5558
      - NODE_ENV=staging
      - DOMAIN=staging.${DOMAIN:-meeshy.me}
      - CORS_ORIGINS=https://staging.${DOMAIN:-meeshy.me},https://gate.staging.${DOMAIN:-meeshy.me}
      - ALLOWED_ORIGINS=https://staging.${DOMAIN:-meeshy.me},https://gate.staging.${DOMAIN:-meeshy.me}
      - FRONTEND_URL=https://staging.${DOMAIN:-meeshy.me}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - UPLOAD_PATH=/app/uploads
      - PUBLIC_URL=https://gate.staging.${DOMAIN:-meeshy.me}
      - MAX_TRANSLATION_LENGTH=10000
      # Variables d'initialisation
      - FORCE_DB_RESET=${FORCE_DB_RESET:-false}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - MEESHY_PASSWORD=${MEESHY_PASSWORD}
      - ATABETH_PASSWORD=${ATABETH_PASSWORD}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - MEESHY_EMAIL=${MEESHY_EMAIL}
      - ATABETH_EMAIL=${ATABETH_EMAIL}
      - ADMIN_SYSTEM_LANGUAGE=${ADMIN_SYSTEM_LANGUAGE}
      - ADMIN_REGIONAL_LANGUAGE=${ADMIN_REGIONAL_LANGUAGE}
      - ADMIN_CUSTOM_DESTINATION_LANGUAGE=${ADMIN_CUSTOM_DESTINATION_LANGUAGE}
      - MEESHY_SYSTEM_LANGUAGE=${MEESHY_SYSTEM_LANGUAGE}
      - MEESHY_REGIONAL_LANGUAGE=${MEESHY_REGIONAL_LANGUAGE}
      - MEESHY_CUSTOM_DESTINATION_LANGUAGE=${MEESHY_CUSTOM_DESTINATION_LANGUAGE}
      - ATABETH_USERNAME=${ATABETH_USERNAME}
      - ATABETH_FIRST_NAME=${ATABETH_FIRST_NAME}
      - ATABETH_LAST_NAME=${ATABETH_LAST_NAME}
      - ATABETH_ROLE=${ATABETH_ROLE}
      - ATABETH_SYSTEM_LANGUAGE=${ATABETH_SYSTEM_LANGUAGE}
      - ATABETH_REGIONAL_LANGUAGE=${ATABETH_REGIONAL_LANGUAGE}
      - ATABETH_CUSTOM_DESTINATION_LANGUAGE=${ATABETH_CUSTOM_DESTINATION_LANGUAGE}
      - FIREBASE_ADMIN_CREDENTIALS_PATH=/app/secrets/firebase-admin-sdk.json
      - ATTACHMENT_MASTER_KEY=${ATTACHMENT_MASTER_KEY}
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY:-}
    volumes:
      - gateway_staging_uploads:/app/uploads
      - ./secrets/firebase-admin-sdk.json:/app/secrets/firebase-admin-sdk.json:ro
    depends_on:
      mongo-init-staging:
        condition: service_completed_successfully
      redis-staging:
        condition: service_healthy
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Router HTTP temporaire
      - "traefik.http.routers.gateway-staging-http.rule=Host(`gate.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.gateway-staging-http.entrypoints=web"
      # Router HTTPS
      - "traefik.http.routers.gateway-staging.rule=Host(`gate.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.gateway-staging.entrypoints=websecure"
      - "traefik.http.routers.gateway-staging.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.gateway-staging.loadbalancer.server.port=3000"

  # ===========================================================================
  # STATIC FILES STAGING - Nginx
  # ===========================================================================
  static-files-staging:
    image: nginx:alpine
    container_name: meeshy-static-files-staging
    restart: unless-stopped
    volumes:
      - frontend_staging_uploads:/usr/share/nginx/html/u:ro
      - gateway_staging_uploads:/usr/share/nginx/html/uploads:ro
      - ./config/nginx/static-files.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.static-staging.rule=Host(`static.staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.static-staging.entrypoints=websecure"
      - "traefik.http.routers.static-staging.tls.certresolver=letsencrypt"
      - "traefik.http.services.static-staging.loadbalancer.server.port=80"

  # ===========================================================================
  # FRONTEND STAGING - Next.js
  # ===========================================================================
  frontend-staging:
    image: ${FRONTEND_IMAGE:-isopen/meeshy-frontend:latest}
    container_name: meeshy-frontend-staging
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=https://gate.staging.${DOMAIN:-meeshy.me}
      - NEXT_PUBLIC_WS_URL=wss://gate.staging.${DOMAIN:-meeshy.me}
      - NEXT_PUBLIC_TRANSLATION_URL=https://ml.staging.${DOMAIN:-meeshy.me}/translate
      - NEXT_PUBLIC_BACKEND_URL=https://gate.staging.${DOMAIN:-meeshy.me}
      - NEXT_PUBLIC_FRONTEND_URL=https://staging.${DOMAIN:-meeshy.me}
      - NEXT_PUBLIC_STATIC_URL=https://static.staging.${DOMAIN:-meeshy.me}
      - NEXT_PUBLIC_DISABLE_CLIENT_TRANSLATION=${NEXT_PUBLIC_DISABLE_CLIENT_TRANSLATION:-true}
      - NEXT_PUBLIC_USE_API_TRANSLATION_ONLY=${NEXT_PUBLIC_USE_API_TRANSLATION_ONLY:-true}
      - NEXT_PUBLIC_DEBUG_LOGS=${NEXT_PUBLIC_DEBUG_LOGS:-false}
      - NODE_ENV=staging
      - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID="G-XF65H07ZRY"
      - NEXT_PUBLIC_FIREBASE_API_KEY="AIzaSyCGBiVIUvW8CiVytXGHN1za2T3yI_7ynro"
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="meeshy-me.firebaseapp.com"
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="meeshy-me.firebasestorage.app"
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID="meeshy-me"
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="775794634022"
      - NEXT_PUBLIC_FIREBASE_APP_ID="1:775794634022:web:d244d7c97208322dc365e7"
      - NEXT_PUBLIC_FIREBASE_VAPID_KEY="BDRguFxJ5f_alFmp-TCGc2VsLAaLEXybgcUGmIE7MMy4jpCjCYJZCcPGV9G1QKN2SBzYQhRuNL28fhKb2hsvvPo"
    volumes:
      - frontend_staging_uploads:/app/public/u
    depends_on:
      gateway-staging:
        condition: service_healthy
    networks:
      - meeshy-staging-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://0.0.0.0:3100"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Router HTTP temporaire (en attendant les certificats SSL)
      - "traefik.http.routers.frontend-staging-http.rule=Host(`staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.frontend-staging-http.entrypoints=web"
      - "traefik.http.routers.frontend-staging-http.priority=1"
      # Router HTTPS (quand les certificats seront disponibles)
      - "traefik.http.routers.frontend-staging.rule=Host(`staging.${DOMAIN:-meeshy.me}`)"
      - "traefik.http.routers.frontend-staging.entrypoints=websecure"
      - "traefik.http.routers.frontend-staging.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend-staging.priority=1"
      # Service partagé par les deux routers
      - "traefik.http.services.frontend-staging.loadbalancer.server.port=3100"

# =============================================================================
# VOLUMES - Tous préfixés "staging_" pour isolation
# =============================================================================
volumes:
  database_staging_data:
    name: meeshy-staging-database-data
  database_staging_config:
    name: meeshy-staging-database-config
  redis_staging_data:
    name: meeshy-staging-redis-data
  redis_staging_ui_data:
    name: meeshy-staging-redis-ui-data
  traefik_staging_certs:
    name: meeshy-staging-traefik-certs
  models_staging_data:
    name: meeshy-staging-models-data
  gateway_staging_uploads:
    name: meeshy-staging-gateway-uploads
  frontend_staging_uploads:
    name: meeshy-staging-web-uploads

# =============================================================================
# NETWORKS - Réseau isolé
# =============================================================================
networks:
  meeshy-staging-network:
    driver: bridge
    name: meeshy-staging-network
