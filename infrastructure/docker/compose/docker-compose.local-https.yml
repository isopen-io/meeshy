# =============================================================================
# MEESHY - Docker Compose Local Development with HTTPS + Network DNS
# =============================================================================
# Usage:
#   make docker-infra                    # Start infrastructure only
#   make start-network                   # Start with network access
#   make start-network HOST=mydev.local  # Custom hostname
#
# Prerequisites:
#   - mkcert installed (brew install mkcert)
#   - Run: make setup-certs-network
#
# Network Access:
#   - Configure other devices to use this machine as DNS server
#   - Or add entries to /etc/hosts on each device
# =============================================================================

services:
  # ===========================================================================
  # DNSMASQ - Local DNS Server for Network Access
  # ===========================================================================
  # Allows other devices (mobile, tablets) to resolve *.meeshy.local
  # Configure your devices to use ${HOST_IP}:53 as DNS server
  dns:
    image: andyshinn/dnsmasq:latest
    container_name: meeshy-dns
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    volumes:
      - ./config/dnsmasq.conf:/etc/dnsmasq.conf:ro
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "nslookup", "meeshy.local", "127.0.0.1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # TRAEFIK - Reverse Proxy with Local HTTPS
  # ===========================================================================
  traefik:
    image: traefik:v3.0
    container_name: meeshy-traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./traefik-dynamic.yml:/etc/traefik/dynamic/traefik.yml:ro
    networks:
      - meeshy-local-network
    labels:
      - "traefik.enable=true"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 3
    # Note: DNS dependency removed - use /etc/hosts for local development
    # depends_on:
    #   dns:
    #     condition: service_healthy

  # ===========================================================================
  # DATABASE - MongoDB with Replica Set
  # ===========================================================================
  database:
    image: mongo:8.0
    container_name: meeshy-local-database
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --noauth
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-meeshy}
    ports:
      - "27017:27017"
    volumes:
      - local_database_data:/data/db
      - local_database_config:/data/configdb
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MongoDB Replica Set Init (one-shot)
  mongo-init:
    image: mongo:8.0
    container_name: meeshy-mongo-init
    depends_on:
      database:
        condition: service_healthy
    networks:
      - meeshy-local-network
    entrypoint: >
      mongosh --host database:27017 --eval '
        try {
          const status = rs.status();
          print("Replica set already initialized, state: " + status.myState);
        } catch (e) {
          print("Initializing replica set...");
          rs.initiate({
            _id: "rs0",
            members: [{ _id: 0, host: "localhost:27017" }]
          });
          print("Replica set initialized!");
        }
      '
    restart: "no"

  # ===========================================================================
  # CACHE - Redis
  # ===========================================================================
  redis:
    image: redis:8-alpine
    container_name: meeshy-local-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - local_redis_data:/data
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # MONGO EXPRESS - MongoDB Web UI (mongo.meeshy.local)
  # ===========================================================================
  mongo-express:
    image: mongo-express:latest
    container_name: meeshy-local-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_SERVER: database
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASS:-admin}
    networks:
      - meeshy-local-network
    depends_on:
      database:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mongo-ui.rule=Host(`mongo.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`mongo.meeshy.local`)"
      - "traefik.http.routers.mongo-ui.entrypoints=websecure"
      - "traefik.http.routers.mongo-ui.tls=true"
      - "traefik.http.services.mongo-ui.loadbalancer.server.port=8081"

  # ===========================================================================
  # REDIS COMMANDER - Redis Web UI (redis.meeshy.local)
  # ===========================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: meeshy-local-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379
    networks:
      - meeshy-local-network
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redis-ui.rule=Host(`redis.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`redis.meeshy.local`)"
      - "traefik.http.routers.redis-ui.entrypoints=websecure"
      - "traefik.http.routers.redis-ui.tls=true"
      - "traefik.http.services.redis-ui.loadbalancer.server.port=8081"

  # ===========================================================================
  # FRONTEND - Next.js (optional, can run natively)
  # ===========================================================================
  frontend:
    image: ${FRONTEND_IMAGE:-isopen/meeshy-frontend:latest}
    container_name: meeshy-local-frontend
    restart: unless-stopped
    profiles: ["full"]
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://meeshy.local/api}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-wss://meeshy.local}
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-https://meeshy.local}
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://meeshy.local/api}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-wss://meeshy.local}
    networks:
      - meeshy-local-network
    labels:
      - "traefik.enable=true"
      # Frontend accessible via: meeshy.local, app.meeshy.local, localhost
      - "traefik.http.routers.frontend.rule=Host(`localhost`) || Host(`meeshy.local`) || Host(`${LOCAL_DOMAIN:-meeshy.local}`) || Host(`app.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`app.meeshy.local`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=3100"
    depends_on:
      - traefik
      - gateway

  # ===========================================================================
  # GATEWAY - Fastify API (optional, can run natively)
  # ===========================================================================
  gateway:
    image: ${GATEWAY_IMAGE:-isopen/meeshy-gateway:latest}
    container_name: meeshy-local-gateway
    restart: unless-stopped
    profiles: ["full"]
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/gateway/Dockerfile
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-meeshy-dev-secret}
      - ZMQ_TRANSLATOR_HOST=translator
      - ZMQ_TRANSLATOR_PORT=5555
    networks:
      - meeshy-local-network
    labels:
      - "traefik.enable=true"
      # Gateway via path: meeshy.local/api
      - "traefik.http.routers.gateway.rule=(Host(`localhost`) || Host(`meeshy.local`) || Host(`${LOCAL_DOMAIN:-meeshy.local}`)) && PathPrefix(`/api`)"
      - "traefik.http.routers.gateway.entrypoints=websecure"
      - "traefik.http.routers.gateway.tls=true"
      - "traefik.http.services.gateway.loadbalancer.server.port=3000"
      # Gateway via subdomain: gate.meeshy.local, api.meeshy.local
      - "traefik.http.routers.gateway-sub.rule=Host(`gate.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`gate.meeshy.local`) || Host(`api.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`api.meeshy.local`)"
      - "traefik.http.routers.gateway-sub.entrypoints=websecure"
      - "traefik.http.routers.gateway-sub.tls=true"
      - "traefik.http.routers.gateway-sub.service=gateway"
      # WebSocket via path
      - "traefik.http.routers.gateway-ws.rule=(Host(`localhost`) || Host(`meeshy.local`) || Host(`${LOCAL_DOMAIN:-meeshy.local}`)) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.gateway-ws.entrypoints=websecure"
      - "traefik.http.routers.gateway-ws.tls=true"
      # WebSocket via subdomain
      - "traefik.http.routers.gateway-ws-sub.rule=(Host(`gate.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`gate.meeshy.local`)) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.gateway-ws-sub.entrypoints=websecure"
      - "traefik.http.routers.gateway-ws-sub.tls=true"
      - "traefik.http.routers.gateway-ws-sub.service=gateway"
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ===========================================================================
  # TRANSLATOR - ML Service (optional, can run natively)
  # ===========================================================================
  translator:
    image: ${TRANSLATOR_IMAGE:-isopen/meeshy-translator:latest}
    container_name: meeshy-local-translator
    restart: unless-stopped
    profiles: ["full"]
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/translator/Dockerfile
    environment:
      - DATABASE_URL=mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      - PYTHONPATH=/workspace
      - HF_HOME=/workspace/models
    ports:
      - "8000:8000"
    volumes:
      - local_models_data:/workspace/models
    networks:
      - meeshy-local-network
    labels:
      - "traefik.enable=true"
      # Translator via subdomain: ml.meeshy.local, translate.meeshy.local
      - "traefik.http.routers.translator.rule=Host(`ml.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`ml.meeshy.local`) || Host(`translate.${LOCAL_DOMAIN:-meeshy.local}`) || Host(`translate.meeshy.local`)"
      - "traefik.http.routers.translator.entrypoints=websecure"
      - "traefik.http.routers.translator.tls=true"
      - "traefik.http.services.translator.loadbalancer.server.port=8000"
    depends_on:
      database:
        condition: service_healthy

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  meeshy-local-network:
    driver: bridge
    name: meeshy-local-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  local_database_data:
    name: meeshy-local-database-data
  local_database_config:
    name: meeshy-local-database-config
  local_redis_data:
    name: meeshy-local-redis-data
  local_models_data:
    name: meeshy-local-models-data
