# =============================================================================
# MEESHY - Docker Compose (Monorepo Build)
# =============================================================================
# Build and run all services from monorepo structure
#
# Usage:
#   docker-compose -f docker-compose.monorepo.yml build
#   docker-compose -f docker-compose.monorepo.yml up -d
#
# URLs:
#   - Frontend: http://localhost:3100
#   - Gateway API: http://localhost:3000
#   - Translator API: http://localhost:8000
#   - MongoDB: mongodb://localhost:27017
#   - Redis: redis://localhost:6379
# =============================================================================

services:
  # MongoDB with Replica Set
  database:
    image: mongo:latest
    container_name: meeshy-database
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --noauth
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-meeshy}
    ports:
      - "27017:27017"
    volumes:
      - database_data:/data/db
      - database_config:/data/configdb
    networks:
      - meeshy-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis Cache
  redis:
    image: redis:8-alpine
    container_name: meeshy-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - meeshy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Translator Service (ML)
  translator:
    image: ${TRANSLATOR_IMAGE:-isopen/meeshy-translator:latest}
    container_name: meeshy-translator
    restart: unless-stopped
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/translator/Dockerfile
    environment:
      - DATABASE_URL=mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      - PYTHONPATH=/workspace
      - PYTHONUNBUFFERED=1
      - HF_HOME=/workspace/models
      - NODE_ENV=${NODE_ENV:-development}
    ports:
      - "8000:8000"
    volumes:
      - models_data:/workspace/models
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - meeshy-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Gateway Service (API) - Monorepo Build
  gateway:
    image: ${GATEWAY_IMAGE:-isopen/meeshy-gateway:latest}
    container_name: meeshy-gateway
    restart: unless-stopped
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/gateway/Dockerfile
    environment:
      - DATABASE_URL=mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      - REDIS_URL=redis://redis:6379
      - TRANSLATOR_URL=http://translator:8000
      - ZMQ_TRANSLATOR_HOST=translator
      - NODE_ENV=${NODE_ENV:-development}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3100}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3100}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-change-in-production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
    ports:
      - "3000:3000"
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
      translator:
        condition: service_healthy
    networks:
      - meeshy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Frontend Service (Next.js) - Monorepo Build
  frontend:
    image: ${FRONTEND_IMAGE:-isopen/meeshy-frontend:latest}
    container_name: meeshy-frontend
    restart: unless-stopped
    build:
      context: ../../..
      dockerfile: infrastructure/docker/images/web/Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
        - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:3000}
        - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-http://gateway:3000}
    environment:
      - NEXT_PUBLIC_WS_URL=ws://localhost:3000
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - NEXT_PUBLIC_BACKEND_URL=http://gateway:3000
      - NEXT_PUBLIC_FRONTEND_URL=http://localhost:3100
      - NODE_ENV=${NODE_ENV:-development}
    ports:
      - "3100:3100"
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - meeshy-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3100/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  meeshy-network:
    driver: bridge
    name: meeshy-network

volumes:
  database_data:
    name: meeshy-database-data
  database_config:
    name: meeshy-database-config
  redis_data:
    name: meeshy-redis-data
  models_data:
    name: meeshy-models-data
