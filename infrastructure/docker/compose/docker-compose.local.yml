# =============================================================================
# MEESHY - Docker Compose Local Development with HTTPS (*.meeshy.local)
# =============================================================================
# Cross-platform configuration for local development with HTTPS
#
# Usage:
#   make docker-local              # Start all services
#   make docker-local-infra        # Start infrastructure only (DB/Redis/UIs)
#   make docker-stop               # Stop all services
#
# Prerequisites:
#   - mkcert installed (brew install mkcert / choco install mkcert)
#   - Run: make setup-certs
#   - Add to /etc/hosts: 127.0.0.1 meeshy.local www.meeshy.local gate.meeshy.local api.meeshy.local ml.meeshy.local mongo.meeshy.local redis.meeshy.local static.meeshy.local traefik.meeshy.local
#
# Services (HTTPS):
#   https://meeshy.local           - Frontend
#   https://gate.meeshy.local      - Gateway API
#   https://ml.meeshy.local        - Translator ML
#   https://mongo.meeshy.local     - MongoDB UI
#   https://redis.meeshy.local     - Redis UI
#   https://static.meeshy.local    - Static files
#   https://traefik.meeshy.local   - Traefik Dashboard
#
# Network Access (optional):
#   make docker-local-network      # Start with DNS for mobile access
# =============================================================================

x-common-env: &common-env
  TZ: ${TZ:-Europe/Paris}

services:
  # ===========================================================================
  # TRAEFIK - Reverse Proxy with Local HTTPS (mkcert)
  # ===========================================================================
  traefik:
    image: traefik:v3.6
    container_name: meeshy-local-traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=meeshy-local-network"
      - "--providers.file.filename=/config/traefik-tls.yml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./config/traefik-tls.yml:/config/traefik-tls.yml:ro
    networks:
      - meeshy-local-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.meeshy.local`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # DATABASE - MongoDB with Replica Set
  # ===========================================================================
  database:
    image: ${DATABASE_IMAGE:-mongo:8.0}
    container_name: meeshy-local-database
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --noauth
    environment:
      <<: *common-env
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-meeshy}
    ports:
      - "27017:27017"
    volumes:
      - local_database_data:/data/db
      - local_database_config:/data/configdb
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MongoDB Replica Set Init (one-shot)
  mongo-init:
    image: ${DATABASE_IMAGE:-mongo:8.0}
    container_name: meeshy-local-mongo-init
    depends_on:
      database:
        condition: service_healthy
    networks:
      - meeshy-local-network
    entrypoint: >
      mongosh --host database:27017 --eval '
        try {
          const status = rs.status();
          print("Replica set already initialized, state: " + status.myState);
        } catch (e) {
          print("Initializing replica set...");
          rs.initiate({
            _id: "rs0",
            members: [{ _id: 0, host: "database:27017" }]
          });
          print("Replica set initialized!");
        }
      '
    restart: "no"

  # ===========================================================================
  # REDIS - Cache
  # ===========================================================================
  redis:
    image: redis:8-alpine
    container_name: meeshy-local-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    environment:
      <<: *common-env
    ports:
      - "6379:6379"
    volumes:
      - local_redis_data:/data
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # NOSQLCLIENT - MongoDB Web UI (mongo.meeshy.local)
  # ===========================================================================
  nosqlclient:
    image: mongoclient/mongoclient:latest
    container_name: meeshy-local-nosqlclient
    restart: unless-stopped
    environment:
      <<: *common-env
      MONGOCLIENT_DEFAULT_CONNECTION_URL: "mongodb://database:27017/${MONGODB_DATABASE:-meeshy}?replicaSet=rs0&directConnection=true"
      ROOT_URL: "https://mongo.meeshy.local"
      PORT: 3000
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nosqlclient.rule=Host(`mongo.meeshy.local`)"
      - "traefik.http.routers.nosqlclient.entrypoints=websecure"
      - "traefik.http.routers.nosqlclient.tls=true"
      - "traefik.http.services.nosqlclient.loadbalancer.server.port=3000"

  # ===========================================================================
  # P3X REDIS UI - Redis Web UI (redis.meeshy.local)
  # ===========================================================================
  p3x-redis-ui:
    image: patrikx3/p3x-redis-ui:latest
    container_name: meeshy-local-p3x-redis-ui
    restart: unless-stopped
    environment:
      <<: *common-env
      P3X_REDIS_UI_SETTINGS: '{"hostname":"redis","port":6379,"password":"","database":0}'
      P3X_REDIS_UI_HTTP_PORT: "7843"
      P3XRS_SETTINGS_PATH: /settings
    volumes:
      - local_redis_ui_data:/settings
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:7843', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.p3x-redis.rule=Host(`redis.meeshy.local`)"
      - "traefik.http.routers.p3x-redis.entrypoints=websecure"
      - "traefik.http.routers.p3x-redis.tls=true"
      - "traefik.http.services.p3x-redis.loadbalancer.server.port=7843"

  # ===========================================================================
  # TRANSLATOR - ML Service (ml.meeshy.local) [profile: full]
  # ===========================================================================
  translator:
    image: ${TRANSLATOR_IMAGE:-isopen/meeshy-translator:latest}
    container_name: meeshy-local-translator
    restart: unless-stopped
    profiles: ["full"]
    environment:
      <<: *common-env
      DATABASE_TYPE: MONGODB
      DATABASE_URL: mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      REDIS_URL: redis://redis:6379
      PYTHONPATH: /workspace
      PYTHONUNBUFFERED: "1"
      NODE_ENV: development
      HF_HOME: /workspace/models
      TRANSFORMERS_CACHE: /workspace/models
      HUGGINGFACE_HUB_CACHE: /workspace/models
      # Diarisation (activée par défaut)
      ENABLE_DIARIZATION: ${ENABLE_DIARIZATION:-true}
    ports:
      - "8000:8000"
      - "5555:5555"
      - "5558:5558"
    volumes:
      - local_models_data:/workspace/models
    depends_on:
      mongo-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "traefik.enable=true"
      # Domain-based access
      - "traefik.http.routers.translator.rule=Host(`ml.meeshy.local`)"
      - "traefik.http.routers.translator.entrypoints=websecure"
      - "traefik.http.routers.translator.tls=true"
      - "traefik.http.services.translator.loadbalancer.server.port=8000"
      # IP-based access with /ml prefix
      - "traefik.http.routers.translator-ip.rule=Host(`192.168.1.171`) && PathPrefix(`/ml`)"
      - "traefik.http.routers.translator-ip.entrypoints=websecure"
      - "traefik.http.routers.translator-ip.tls=true"
      - "traefik.http.routers.translator-ip.service=translator"
      - "traefik.http.routers.translator-ip.priority=15"
      - "traefik.http.middlewares.strip-ml.stripprefix.prefixes=/ml"
      - "traefik.http.routers.translator-ip.middlewares=strip-ml"

  # ===========================================================================
  # GATEWAY - API Service (gate.meeshy.local) [profile: full]
  # ===========================================================================
  gateway:
    image: ${GATEWAY_IMAGE:-isopen/meeshy-gateway:latest}
    container_name: meeshy-local-gateway
    restart: unless-stopped
    profiles: ["full"]
    environment:
      <<: *common-env
      DATABASE_TYPE: MONGODB
      DATABASE_URL: mongodb://database:27017/meeshy?replicaSet=rs0&directConnection=true
      REDIS_URL: redis://redis:6379
      TRANSLATOR_URL: http://translator:8000
      ZMQ_PUSH_URL: tcp://translator:5555
      ZMQ_SUB_URL: tcp://translator:5558
      ZMQ_TRANSLATOR_HOST: translator
      ZMQ_TRANSLATOR_PUSH_PORT: "5555"
      ZMQ_TRANSLATOR_SUB_PORT: "5558"
      NODE_ENV: development
      # CORS: Include both HTTPS (via Traefik) and HTTP (direct port) origins
      CORS_ORIGINS: https://meeshy.local,https://www.meeshy.local,https://gate.meeshy.local,https://192.168.1.171,https://smpdev02.local,https://smpdev02.home,http://192.168.1.171:3100,http://localhost:3100
      ALLOWED_ORIGINS: https://meeshy.local,https://www.meeshy.local,https://gate.meeshy.local,https://192.168.1.171,https://smpdev02.local,https://smpdev02.home,http://192.168.1.171:3100,http://localhost:3100
      FRONTEND_URL: https://meeshy.local
      PUBLIC_URL: https://gate.meeshy.local
      JWT_SECRET: ${JWT_SECRET:-local-dev-jwt-secret}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      # Attachment Encryption
      ATTACHMENT_MASTER_KEY: ${ATTACHMENT_MASTER_KEY:-3To8V/l+VWjyQ3HzYHc7SHr597jub0iRv35A0UGHZrA=}
      # Email Service (Brevo)
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-brevo}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@meeshy.me}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Meeshy}
      BREVO_API_KEY: ${BREVO_API_KEY:-}
      # Captcha bypass for development
      BYPASS_CAPTCHA: ${BYPASS_CAPTCHA:-true}
      # User initialization
      FORCE_DB_RESET: ${FORCE_DB_RESET:-false}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@meeshy.local}
      MEESHY_PASSWORD: ${MEESHY_PASSWORD:-meeshy123}
      MEESHY_EMAIL: ${MEESHY_EMAIL:-meeshy@meeshy.local}
      ATABETH_PASSWORD: ${ATABETH_PASSWORD:-atabeth123}
      ATABETH_EMAIL: ${ATABETH_EMAIL:-atabeth@meeshy.local}
      ATABETH_USERNAME: ${ATABETH_USERNAME:-atabeth}
      ATABETH_FIRST_NAME: ${ATABETH_FIRST_NAME:-Atabeth}
      ATABETH_LAST_NAME: ${ATABETH_LAST_NAME:-User}
      ATABETH_ROLE: ${ATABETH_ROLE:-user}
    ports:
      - "3000:3000"
    depends_on:
      mongo-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Main router for domain-based access
      - "traefik.http.routers.gateway.rule=Host(`gate.meeshy.local`) || Host(`api.meeshy.local`)"
      - "traefik.http.routers.gateway.entrypoints=websecure"
      - "traefik.http.routers.gateway.tls=true"
      - "traefik.http.services.gateway.loadbalancer.server.port=3000"
      # IP-based router with path prefix for API access (mobile devices)
      - "traefik.http.routers.gateway-ip.rule=Host(`192.168.1.171`) && PathPrefix(`/api`)"
      - "traefik.http.routers.gateway-ip.entrypoints=websecure"
      - "traefik.http.routers.gateway-ip.tls=true"
      - "traefik.http.routers.gateway-ip.service=gateway"
      - "traefik.http.routers.gateway-ip.priority=10"
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.routers.gateway-ip.middlewares=strip-api"

  # ===========================================================================
  # STATIC FILES - Nginx (static.meeshy.local) [profile: full]
  # ===========================================================================
  static-files:
    image: nginx:alpine
    container_name: meeshy-local-static-files
    restart: unless-stopped
    profiles: ["full"]
    volumes:
      - local_frontend_uploads:/usr/share/nginx/html/u:ro
      - ./config/nginx/static-files.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # Domain-based access
      - "traefik.http.routers.static.rule=Host(`static.meeshy.local`) || Host(`statics.meeshy.local`)"
      - "traefik.http.routers.static.entrypoints=websecure"
      - "traefik.http.routers.static.tls=true"
      - "traefik.http.services.static.loadbalancer.server.port=80"
      # IP-based access with /static prefix
      - "traefik.http.routers.static-ip.rule=Host(`192.168.1.171`) && PathPrefix(`/static`)"
      - "traefik.http.routers.static-ip.entrypoints=websecure"
      - "traefik.http.routers.static-ip.tls=true"
      - "traefik.http.routers.static-ip.service=static"
      - "traefik.http.routers.static-ip.priority=12"
      - "traefik.http.middlewares.strip-static.stripprefix.prefixes=/static"
      - "traefik.http.routers.static-ip.middlewares=strip-static"

  # ===========================================================================
  # FRONTEND - Next.js (meeshy.local) [profile: full]
  # ===========================================================================
  frontend:
    image: ${FRONTEND_IMAGE:-isopen/meeshy-web:latest}
    container_name: meeshy-local-frontend
    restart: unless-stopped
    profiles: ["full"]
    environment:
      <<: *common-env
      # SSR (server-side rendering) URLs - used by Next.js server / BFF
      INTERNAL_BACKEND_URL: http://gateway:3000
      INTERNAL_WS_URL: ws://gateway:3000
      INTERNAL_TRANSLATION_URL: http://translator:8000
      # Client-side URLs - replaced at container startup by entrypoint script
      NEXT_PUBLIC_API_URL: https://gate.meeshy.local
      NEXT_PUBLIC_BACKEND_URL: https://gate.meeshy.local
      NEXT_PUBLIC_WS_URL: wss://gate.meeshy.local
      NEXT_PUBLIC_FRONTEND_URL: https://meeshy.local
      NEXT_PUBLIC_TRANSLATION_URL: https://ml.meeshy.local
      NEXT_PUBLIC_STATIC_URL: https://static.meeshy.local
      # Feature flags
      NEXT_PUBLIC_DISABLE_CLIENT_TRANSLATION: "true"
      NEXT_PUBLIC_USE_API_TRANSLATION_ONLY: "true"
      NEXT_PUBLIC_DEBUG_LOGS: "true"
      NODE_ENV: development
    ports:
      - "3100:3100"
    volumes:
      - local_frontend_uploads:/app/public/u
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - meeshy-local-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3100"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Main router for domain-based access
      - "traefik.http.routers.frontend.rule=Host(`meeshy.local`) || Host(`www.meeshy.local`) || Host(`smpdev02.local`) || Host(`smpdev02.home`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=3100"
      - "traefik.http.routers.frontend.priority=1"
      # IP-based router for direct access (mobile devices)
      - "traefik.http.routers.frontend-ip.rule=Host(`192.168.1.171`)"
      - "traefik.http.routers.frontend-ip.entrypoints=websecure"
      - "traefik.http.routers.frontend-ip.tls=true"
      - "traefik.http.routers.frontend-ip.service=frontend"
      - "traefik.http.routers.frontend-ip.priority=1"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  meeshy-local-network:
    driver: bridge
    name: meeshy-local-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  local_database_data:
    name: meeshy-local-database-data
  local_database_config:
    name: meeshy-local-database-config
  local_redis_data:
    name: meeshy-local-redis-data
  local_redis_ui_data:
    name: meeshy-local-redis-ui-data
  local_models_data:
    name: meeshy-local-models-data
  local_frontend_uploads:
    name: meeshy-local-frontend-uploads
