# =============================================================================
# MEESHY - Docker Build & Push Pipeline
# =============================================================================
# Multi-architecture builds using native runners (no QEMU emulation)
# - AMD64: ubuntu-latest (x86_64)
# - ARM64: ubuntu-24.04-arm64 (native ARM)
# Registry: Docker Hub (isopen/meeshy-*)
# Package managers: bun (default) or pnpm
# GPU support: translator service supports cpu and gpu (CUDA 12.4) variants
# =============================================================================

name: Docker

on:
  push:
    branches: [main, dev]
    tags: ['v*.*.*']
    paths:
      - 'apps/web/**'
      - 'services/gateway/**'
      - 'services/translator/**'
      - 'packages/shared/**'
      - 'infrastructure/docker/**'
      - '.github/workflows/docker.yml'

  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated or preset)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - gateway
          - translator
          - web,gateway
          - web,translator
          - gateway,translator
      custom_services:
        description: 'Custom services (overrides above if set, e.g., "web,gateway")'
        required: false
        type: string
      push_to_registry:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        default: 'linux/amd64,linux/arm64'
        options:
          - linux/amd64,linux/arm64
          - linux/amd64
          - linux/arm64
      package_manager:
        description: 'Package manager for builds'
        required: false
        type: choice
        default: 'bun'
        options:
          - bun
          - pnpm
      torch_backend:
        description: 'Torch backend for translator (cpu, gpu, all)'
        required: false
        type: choice
        default: 'cpu'
        options:
          - cpu
          - gpu
          - all
      no_cache:
        description: 'Build without cache (force rebuild)'
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: isopen
  NODE_VERSION: '22'
  BUN_VERSION: '1.1.38'
  PNPM_VERSION: '9'
  PACKAGE_MANAGER: ${{ github.event.inputs.package_manager || 'bun' }}

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # DETECT: Which services need building
  # ===========================================================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.result }}
      has_changes: ${{ steps.services.outputs.has_changes }}
      platforms_amd64: ${{ steps.platforms.outputs.amd64 }}
      platforms_arm64: ${{ steps.platforms.outputs.arm64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES="${{ github.event.inputs.custom_services }}"
            if [[ -z "$SERVICES" ]]; then
              SERVICES="${{ github.event.inputs.services }}"
            fi

            if [[ "$SERVICES" == "all" ]]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "gateway=true" >> $GITHUB_OUTPUT
              echo "translator=true" >> $GITHUB_OUTPUT
            else
              echo "web=$([[ "$SERVICES" == *"web"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "gateway=$([[ "$SERVICES" == *"gateway"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "translator=$([[ "$SERVICES" == *"translator"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "gateway=true" >> $GITHUB_OUTPUT
            echo "translator=true" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
            echo "web=$([[ "$CHANGED" == *"apps/web/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/web/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "gateway=$([[ "$CHANGED" == *"services/gateway/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/gateway/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "translator=$([[ "$CHANGED" == *"services/translator/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/translator/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Determine platforms
        id: platforms
        run: |
          PLATFORMS="${{ github.event.inputs.platforms || 'linux/amd64,linux/arm64' }}"
          echo "amd64=$([[ "$PLATFORMS" == *"amd64"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "arm64=$([[ "$PLATFORMS" == *"arm64"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Build services list
        id: services
        run: |
          SERVICES='{"include":['
          FIRST=true
          HAS_CHANGES=false

          TORCH_INPUT="${{ github.event.inputs.torch_backend }}"
          if [[ -z "$TORCH_INPUT" ]]; then
            TORCH_INPUT="cpu"
          fi

          if [[ "${{ steps.changes.outputs.web }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat apps/web/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && SERVICES+=','
            SERVICES+='{"service":"web","context":".","dockerfile":"./infrastructure/docker/images/web/Dockerfile","image":"meeshy-web","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.gateway }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/gateway/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && SERVICES+=','
            SERVICES+='{"service":"gateway","context":".","dockerfile":"./infrastructure/docker/images/gateway/Dockerfile","image":"meeshy-gateway","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.translator }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/translator/VERSION 2>/dev/null || echo "1.0.0")

            if [[ "$TORCH_INPUT" == "cpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && SERVICES+=','
              SERVICES+='{"service":"translator","context":".","dockerfile":"./infrastructure/docker/images/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"cpu"}'
              FIRST=false
            fi

            if [[ "$TORCH_INPUT" == "gpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && SERVICES+=','
              SERVICES+='{"service":"translator-gpu","context":".","dockerfile":"./infrastructure/docker/images/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"gpu"}'
              FIRST=false
            fi
          fi

          SERVICES+=']}'
          echo "result=$SERVICES" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ===========================================================================
  # BUILD AMD64: Native x86_64 builds
  # ===========================================================================
  build-amd64:
    name: Build ${{ matrix.service }} (amd64)
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_changes == 'true' && needs.detect.outputs.platforms_amd64 == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    permissions:
      contents: read
      packages: write

    outputs:
      digests: ${{ steps.collect.outputs.digests }}

    steps:
      - name: Free Disk Space (translator)
        if: matrix.service == 'translator' || matrix.service == 'translator-gpu'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:${{ matrix.version }}-amd64${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          no-cache: ${{ github.event.inputs.no_cache == 'true' }}
          cache-from: ${{ github.event.inputs.no_cache != 'true' && format('type=gha,scope={0}-amd64', matrix.service) || '' }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-amd64
          provenance: false
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ matrix.version }}
            PACKAGE_MANAGER=${{ env.PACKAGE_MANAGER }}
            TORCH_BACKEND=${{ matrix.torch_backend || 'cpu' }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests/${{ matrix.service }}
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.service }}/amd64

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.service }}-amd64${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          path: /tmp/digests/${{ matrix.service }}
          retention-days: 1

  # ===========================================================================
  # BUILD ARM64: Native ARM builds (no QEMU emulation)
  # ===========================================================================
  build-arm64:
    name: Build ${{ matrix.service }} (arm64)
    runs-on: ubuntu-24.04-arm64
    needs: detect
    if: needs.detect.outputs.has_changes == 'true' && needs.detect.outputs.platforms_arm64 == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk Space (translator)
        if: matrix.service == 'translator' || matrix.service == 'translator-gpu'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/arm64
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:${{ matrix.version }}-arm64${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          no-cache: ${{ github.event.inputs.no_cache == 'true' }}
          cache-from: ${{ github.event.inputs.no_cache != 'true' && format('type=gha,scope={0}-arm64', matrix.service) || '' }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}-arm64
          provenance: false
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ matrix.version }}
            PACKAGE_MANAGER=${{ env.PACKAGE_MANAGER }}
            TORCH_BACKEND=${{ matrix.torch_backend || 'cpu' }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests/${{ matrix.service }}
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.service }}/arm64

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.service }}-arm64${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          path: /tmp/digests/${{ matrix.service }}
          retention-days: 1

  # ===========================================================================
  # MERGE: Create multi-arch manifests
  # ===========================================================================
  merge-manifests:
    name: Merge ${{ matrix.service }} manifests
    runs-on: ubuntu-latest
    needs: [detect, build-amd64, build-arm64]
    if: always() && needs.detect.outputs.has_changes == 'true' && (needs.build-amd64.result == 'success' || needs.build-arm64.result == 'success')
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine available platforms
        id: platforms
        run: |
          PLATFORMS=""
          AMD64="${{ needs.detect.outputs.platforms_amd64 }}"
          ARM64="${{ needs.detect.outputs.platforms_arm64 }}"
          AMD64_SUCCESS="${{ needs.build-amd64.result == 'success' }}"
          ARM64_SUCCESS="${{ needs.build-arm64.result == 'success' }}"

          if [[ "$AMD64" == "true" && "$AMD64_SUCCESS" == "true" ]]; then
            PLATFORMS="linux/amd64"
          fi
          if [[ "$ARM64" == "true" && "$ARM64_SUCCESS" == "true" ]]; then
            [[ -n "$PLATFORMS" ]] && PLATFORMS+=","
            PLATFORMS+="linux/arm64"
          fi

          echo "list=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "Available platforms: $PLATFORMS"

      - name: Create and push manifest
        run: |
          IMAGE="${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}"
          VERSION="${{ matrix.version }}"
          GPU_SUFFIX="${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}"

          # Collect available images
          IMAGES=""
          if [[ "${{ needs.detect.outputs.platforms_amd64 }}" == "true" && "${{ needs.build-amd64.result }}" == "success" ]]; then
            IMAGES+="${IMAGE}:${VERSION}-amd64${GPU_SUFFIX} "
          fi
          if [[ "${{ needs.detect.outputs.platforms_arm64 }}" == "true" && "${{ needs.build-arm64.result }}" == "success" ]]; then
            IMAGES+="${IMAGE}:${VERSION}-arm64${GPU_SUFFIX} "
          fi

          if [[ -z "$IMAGES" ]]; then
            echo "No images available to merge"
            exit 1
          fi

          echo "Creating manifest for: $IMAGES"

          # Create versioned manifest
          docker buildx imagetools create -t ${IMAGE}:v${VERSION}${GPU_SUFFIX} $IMAGES

          # Create latest tag for main/dev branches
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/dev" ]]; then
            docker buildx imagetools create -t ${IMAGE}:latest${GPU_SUFFIX} $IMAGES
          fi

          # Create branch tag
          BRANCH="${{ github.ref_name }}"
          docker buildx imagetools create -t ${IMAGE}:${BRANCH}${GPU_SUFFIX} $IMAGES

          # Create sha tag
          SHA="${{ github.sha }}"
          docker buildx imagetools create -t ${IMAGE}:sha-${SHA::7}${GPU_SUFFIX} $IMAGES

          # Create torch backend tag for translator
          if [[ "${{ matrix.service }}" == "translator" || "${{ matrix.service }}" == "translator-gpu" ]]; then
            docker buildx imagetools create -t ${IMAGE}:${{ matrix.torch_backend || 'cpu' }} $IMAGES
          fi

      - name: Build summary
        run: |
          echo "### ${{ matrix.service }} Multi-arch Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | \`${{ steps.platforms.outputs.list }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # SECURITY: Scan images
  # ===========================================================================
  security-scan:
    name: Scan ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect, merge-manifests]
    if: needs.merge-manifests.result == 'success' && github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    permissions:
      security-events: write

    steps:
      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'

  # ===========================================================================
  # CLEANUP: Remove architecture-specific tags
  # ===========================================================================
  cleanup:
    name: Cleanup temp tags
    runs-on: ubuntu-latest
    needs: [detect, merge-manifests]
    if: needs.merge-manifests.result == 'success'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    steps:
      - name: Note about cleanup
        run: |
          echo "### Cleanup Note" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Architecture-specific tags (*-amd64, *-arm64) are retained for debugging." >> $GITHUB_STEP_SUMMARY
          echo "To remove them manually, use Docker Hub API or dashboard." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFY
  # ===========================================================================
  notify:
    name: Summary
    runs-on: ubuntu-latest
    needs: [detect, build-amd64, build-arm64, merge-manifests]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manager:** ${{ env.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Strategy:** Native runners (no QEMU)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AMD64 Build | ${{ needs.build-amd64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ARM64 Build | ${{ needs.build-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge Manifests | ${{ needs.merge-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
