# =============================================================================
# MEESHY - Docker Build & Push Pipeline
# =============================================================================
# Multi-architecture builds for all services
# Supports: linux/amd64, linux/arm64
# Registry: Docker Hub (isopen/meeshy-*)
# Package managers: bun (default) or pnpm
# GPU support: translator service supports cpu and gpu (CUDA 12.4) variants
# =============================================================================

name: Docker

on:
  push:
    branches: [main, dev]
    tags: ['v*.*.*']
    paths:
      - 'apps/web/**'
      - 'services/gateway/**'
      - 'services/translator/**'
      - 'packages/shared/**'
      - 'infrastructure/docker/**'
      - '.github/workflows/docker.yml'

  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated or preset)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - gateway
          - translator
          - web,gateway
          - web,translator
          - gateway,translator
      custom_services:
        description: 'Custom services (overrides above if set, e.g., "web,gateway")'
        required: false
        type: string
      push_to_registry:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        default: 'linux/amd64,linux/arm64'
        options:
          - linux/amd64,linux/arm64
          - linux/amd64
          - linux/arm64
      package_manager:
        description: 'Package manager for builds'
        required: false
        type: choice
        default: 'bun'
        options:
          - bun
          - pnpm
      torch_backend:
        description: 'Torch backend for translator (cpu, gpu, all)'
        required: false
        type: choice
        default: 'cpu'
        options:
          - cpu
          - gpu
          - all
      no_cache:
        description: 'Build without cache (force rebuild)'
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: isopen
  PLATFORMS: linux/amd64,linux/arm64
  NODE_VERSION: '22'
  BUN_VERSION: '1.1.38'
  PNPM_VERSION: '9'
  PACKAGE_MANAGER: ${{ github.event.inputs.package_manager || 'bun' }}

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # DETECT: Which services need building
  # ===========================================================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      has_changes: ${{ steps.matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use custom_services if provided, otherwise use services dropdown
            SERVICES="${{ github.event.inputs.custom_services }}"
            if [[ -z "$SERVICES" ]]; then
              SERVICES="${{ github.event.inputs.services }}"
            fi

            if [[ "$SERVICES" == "all" ]]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "gateway=true" >> $GITHUB_OUTPUT
              echo "translator=true" >> $GITHUB_OUTPUT
            else
              echo "web=$([[ "$SERVICES" == *"web"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "gateway=$([[ "$SERVICES" == *"gateway"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "translator=$([[ "$SERVICES" == *"translator"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "gateway=true" >> $GITHUB_OUTPUT
            echo "translator=true" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
            echo "web=$([[ "$CHANGED" == *"apps/web/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/web/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "gateway=$([[ "$CHANGED" == *"services/gateway/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/gateway/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "translator=$([[ "$CHANGED" == *"services/translator/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] || [[ "$CHANGED" == *"infrastructure/docker/images/translator/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Build matrix
        id: matrix
        run: |
          MATRIX='{"include":['
          FIRST=true
          HAS_CHANGES=false

          # Determine torch backend selection
          TORCH_INPUT="${{ github.event.inputs.torch_backend }}"
          if [[ -z "$TORCH_INPUT" ]]; then
            TORCH_INPUT="cpu"
          fi

          if [[ "${{ steps.changes.outputs.web }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat apps/web/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && MATRIX+=','
            MATRIX+='{"service":"web","context":".","dockerfile":"./infrastructure/docker/images/web/Dockerfile","image":"meeshy-web","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.gateway }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/gateway/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && MATRIX+=','
            MATRIX+='{"service":"gateway","context":".","dockerfile":"./infrastructure/docker/images/gateway/Dockerfile","image":"meeshy-gateway","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.translator }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/translator/VERSION 2>/dev/null || echo "1.0.0")

            # Add CPU variant (default or when 'all' or 'cpu' selected)
            if [[ "$TORCH_INPUT" == "cpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"service":"translator","context":".","dockerfile":"./infrastructure/docker/images/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"cpu"}'
              FIRST=false
            fi

            # Add GPU variant (CUDA 12.4) when 'all' or 'gpu' selected
            if [[ "$TORCH_INPUT" == "gpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && MATRIX+=','
              MATRIX+='{"service":"translator-gpu","context":".","dockerfile":"./infrastructure/docker/images/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"gpu"}'
              FIRST=false
            fi
          fi

          MATRIX+=']}'
          echo "result=$MATRIX" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ===========================================================================
  # BUILD: Multi-architecture Docker builds
  # ===========================================================================
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Free Disk Space (Ubuntu)
        if: matrix.service == 'translator' || matrix.service == 'translator-gpu'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm version is read from packageManager field in package.json
      - name: Setup pnpm
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Note: shared files are copied directly in Dockerfiles from monorepo root context

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clean Docker cache (translator)
        if: matrix.service == 'translator' || matrix.service == 'translator-gpu'
        run: |
          docker system prune -af --volumes || true
          df -h

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}
          tags: |
            type=raw,value=v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
            type=raw,value=latest${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }},enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' }}
            type=raw,value=${{ matrix.torch_backend || 'cpu' }},enable=${{ matrix.service == 'translator' || matrix.service == 'translator-gpu' }}
            type=ref,event=branch,suffix=${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
            type=sha,prefix=sha-,format=short,suffix=${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
            type=ref,event=tag

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ github.event.inputs.platforms || env.PLATFORMS }}
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: ${{ github.event.inputs.no_cache == 'true' }}
          cache-from: ${{ github.event.inputs.no_cache != 'true' && format('type=gha,scope={0}', matrix.service) || '' }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          provenance: true
          sbom: true
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ matrix.version }}
            PACKAGE_MANAGER=${{ env.PACKAGE_MANAGER }}
            TORCH_BACKEND=${{ matrix.torch_backend || 'cpu' }}

      - name: Validate image metadata
        if: success()
        run: |
          echo "### Image Validation" >> $GITHUB_STEP_SUMMARY
          echo "Checking labels and metadata..." >> $GITHUB_STEP_SUMMARY
          docker buildx imagetools inspect ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }} --format '{{json .}}' | jq '.manifest.annotations' >> $GITHUB_STEP_SUMMARY || true

      - name: Security scan
        uses: aquasecurity/trivy-action@master
        if: github.event_name != 'pull_request'
        with:
          image-ref: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        if: github.event_name != 'pull_request'
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'

      - name: Build summary
        run: |
          echo "### ${{ matrix.service }} Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Torch Backend | \`${{ matrix.torch_backend || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | \`${{ env.PLATFORMS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFY
  # ===========================================================================
  notify:
    name: Summary
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manager:** ${{ env.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "All images built and pushed successfully." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "skipped" ]]; then
            echo "No services required building." >> $GITHUB_STEP_SUMMARY
          else
            echo "Build failed. Check logs." >> $GITHUB_STEP_SUMMARY
          fi
