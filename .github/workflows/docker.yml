# =============================================================================
# MEESHY - Docker Build & Push Pipeline
# =============================================================================
# Multi-architecture builds for all services
# Supports: linux/amd64, linux/arm64
# Registry: Docker Hub (isopen/meeshy-*)
# =============================================================================

name: Docker

on:
  push:
    branches: [main, dev]
    tags: ['v*.*.*']
    paths:
      - 'apps/web/**'
      - 'services/gateway/**'
      - 'services/translator/**'
      - 'packages/shared/**'
      - '.github/workflows/docker.yml'

  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - gateway
          - translator

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: isopen
  PLATFORMS: linux/amd64,linux/arm64
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # DETECT: Which services need building
  # ===========================================================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      has_changes: ${{ steps.matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES="${{ github.event.inputs.services }}"
            if [[ "$SERVICES" == "all" ]]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "gateway=true" >> $GITHUB_OUTPUT
              echo "translator=true" >> $GITHUB_OUTPUT
            else
              echo "web=$([[ "$SERVICES" == *"web"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "gateway=$([[ "$SERVICES" == *"gateway"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "translator=$([[ "$SERVICES" == *"translator"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "gateway=true" >> $GITHUB_OUTPUT
            echo "translator=true" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
            echo "web=$([[ "$CHANGED" == *"apps/web/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "gateway=$([[ "$CHANGED" == *"services/gateway/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "translator=$([[ "$CHANGED" == *"services/translator/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Build matrix
        id: matrix
        run: |
          MATRIX='{"include":['
          FIRST=true
          HAS_CHANGES=false

          if [[ "${{ steps.changes.outputs.web }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat apps/web/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && MATRIX+=','
            MATRIX+='{"service":"web","context":"./apps/web","dockerfile":"./apps/web/Dockerfile","image":"meeshy-frontend","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.gateway }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/gateway/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && MATRIX+=','
            MATRIX+='{"service":"gateway","context":"./services/gateway","dockerfile":"./services/gateway/Dockerfile","image":"meeshy-gateway","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.translator }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/translator/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && MATRIX+=','
            MATRIX+='{"service":"translator","context":"./services/translator","dockerfile":"./services/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'"}'
            FIRST=false
          fi

          MATRIX+=']}'
          echo "result=$MATRIX" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ===========================================================================
  # BUILD: Multi-architecture Docker builds
  # ===========================================================================
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Prepare shared files
        run: |
          # Copy shared package to service context for Docker build
          mkdir -p ${{ matrix.context }}/shared
          cp -r packages/shared/* ${{ matrix.context }}/shared/ 2>/dev/null || true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}
          tags: |
            type=raw,value=v${{ matrix.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' }}
            type=ref,event=branch
            type=sha,prefix=sha-,format=short
            type=ref,event=tag

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ env.PLATFORMS }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          provenance: true
          sbom: true
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ matrix.version }}

      - name: Security scan
        uses: aquasecurity/trivy-action@master
        if: github.event_name != 'pull_request'
        with:
          image-ref: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:v${{ matrix.version }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        if: github.event_name != 'pull_request'
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'

      - name: Build summary
        run: |
          echo "### ${{ matrix.service }} Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${{ matrix.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | \`${{ env.PLATFORMS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFY
  # ===========================================================================
  notify:
    name: Summary
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "All images built and pushed successfully." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "skipped" ]]; then
            echo "No services required building." >> $GITHUB_STEP_SUMMARY
          else
            echo "Build failed. Check logs." >> $GITHUB_STEP_SUMMARY
          fi
