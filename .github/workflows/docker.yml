# =============================================================================
# MEESHY - Docker Build & Push Pipeline
# =============================================================================
# Multi-architecture builds: AMD64 by default (linux/amd64)
# ARM64 builds available via manual trigger but may fail with Prisma (QEMU limitations)
# Registry: Docker Hub (isopen/meeshy-*)
# Package managers: bun (default) or pnpm
# GPU support: translator service supports cpu and gpu (CUDA 12.4) variants
#
# IMPORTANT: GitHub Actions ARM64 runners (ubuntu-24.04-arm64) are not available
# on free tier. ARM64 builds use QEMU emulation which has known issues with
# native binaries like Prisma (SIGILL errors). For production ARM64 images,
# use self-hosted ARM64 runners or build locally.
# =============================================================================

name: Docker

on:
  push:
    branches: [main, dev]
    tags: ['v*.*.*']
    paths:
      - 'apps/web/**'
      - 'services/gateway/**'
      - 'services/translator/**'
      - 'packages/shared/**'
      - 'infrastructure/docker/**'
      - '.github/workflows/docker.yml'

  workflow_dispatch:
    inputs:
      services:
        description: 'Services to build (comma-separated or preset)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web
          - gateway
          - translator
          - web,gateway
          - web,translator
          - gateway,translator
      custom_services:
        description: 'Custom services (overrides above if set, e.g., "web,gateway")'
        required: false
        type: string
      push_to_registry:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        default: 'linux/amd64,linux/arm64'
        options:
          - linux/amd64,linux/arm64
          - linux/amd64
          - linux/arm64
      package_manager:
        description: 'Package manager for builds'
        required: false
        type: choice
        default: 'bun'
        options:
          - bun
          - pnpm
      torch_backend:
        description: 'Torch backend for translator (cpu, gpu, all)'
        required: false
        type: choice
        default: 'cpu'
        options:
          - cpu
          - gpu
          - all
      no_cache:
        description: 'Build without cache (force rebuild)'
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: isopen
  PLATFORMS: linux/amd64
  NODE_VERSION: '22'
  BUN_VERSION: '1.1.38'
  PNPM_VERSION: '9'
  PACKAGE_MANAGER: ${{ github.event.inputs.package_manager || 'bun' }}

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # DETECT: Which services need building
  # ===========================================================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.result }}
      has_changes: ${{ steps.services.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES="${{ github.event.inputs.custom_services }}"
            if [[ -z "$SERVICES" ]]; then
              SERVICES="${{ github.event.inputs.services }}"
            fi

            if [[ "$SERVICES" == "all" ]]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "gateway=true" >> $GITHUB_OUTPUT
              echo "translator=true" >> $GITHUB_OUTPUT
            else
              echo "web=$([[ "$SERVICES" == *"web"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "gateway=$([[ "$SERVICES" == *"gateway"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "translator=$([[ "$SERVICES" == *"translator"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "gateway=true" >> $GITHUB_OUTPUT
            echo "translator=true" >> $GITHUB_OUTPUT
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
            echo "web=$([[ "$CHANGED" == *"apps/web/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "gateway=$([[ "$CHANGED" == *"services/gateway/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "translator=$([[ "$CHANGED" == *"services/translator/"* ]] || [[ "$CHANGED" == *"packages/shared/"* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Build services list
        id: services
        run: |
          SERVICES='{"include":['
          FIRST=true
          HAS_CHANGES=false

          TORCH_INPUT="${{ github.event.inputs.torch_backend }}"
          if [[ -z "$TORCH_INPUT" ]]; then
            TORCH_INPUT="cpu"
          fi

          if [[ "${{ steps.changes.outputs.web }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat apps/web/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && SERVICES+=','
            SERVICES+='{"service":"web","context":".","dockerfile":"./apps/web/Dockerfile","image":"meeshy-web","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.gateway }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/gateway/VERSION 2>/dev/null || echo "1.0.0")
            [[ "$FIRST" == "false" ]] && SERVICES+=','
            SERVICES+='{"service":"gateway","context":".","dockerfile":"./services/gateway/Dockerfile","image":"meeshy-gateway","version":"'$VERSION'"}'
            FIRST=false
          fi

          if [[ "${{ steps.changes.outputs.translator }}" == "true" ]]; then
            HAS_CHANGES=true
            VERSION=$(cat services/translator/VERSION 2>/dev/null || echo "1.0.0")

            if [[ "$TORCH_INPUT" == "cpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && SERVICES+=','
              SERVICES+='{"service":"translator","context":".","dockerfile":"./services/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"cpu"}'
              FIRST=false
            fi

            if [[ "$TORCH_INPUT" == "gpu" ]] || [[ "$TORCH_INPUT" == "all" ]]; then
              [[ "$FIRST" == "false" ]] && SERVICES+=','
              SERVICES+='{"service":"translator-gpu","context":".","dockerfile":"./services/translator/Dockerfile","image":"meeshy-translator","version":"'$VERSION'","torch_backend":"gpu"}'
              FIRST=false
            fi
          fi

          SERVICES+=']}'
          echo "result=$SERVICES" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  # ===========================================================================
  # BUILD: Multi-architecture Docker builds (AMD64 by default)
  # ARM64 builds via QEMU available on manual trigger (may fail with Prisma)
  # ===========================================================================
  build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Free Disk Space (translator)
        if: matrix.service == 'translator' || matrix.service == 'translator-gpu'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for ARM64 emulation if needed)
        if: contains(github.event.inputs.platforms || env.PLATFORMS, 'arm64')
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate build timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d.%H%M%S")
          echo "value=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Build timestamp: $TIMESTAMP"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}
          tags: |
            type=raw,value=${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=${{ matrix.version }}-${{ steps.timestamp.outputs.value }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }},enable=${{ github.ref == 'refs/heads/dev' }}
            type=raw,value=latest${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=staging${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }},enable=${{ github.ref == 'refs/heads/dev' }}
            type=raw,value=${{ matrix.torch_backend || 'cpu' }},enable=${{ matrix.service == 'translator' || matrix.service == 'translator-gpu' }}
            type=ref,event=branch,suffix=${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
            type=sha,prefix=sha-,format=short,suffix=${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ github.event.inputs.platforms || env.PLATFORMS }}
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: ${{ github.event.inputs.no_cache == 'true' }}
          cache-from: ${{ github.event.inputs.no_cache != 'true' && format('type=gha,scope={0}', matrix.service) || '' }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          provenance: true
          sbom: true
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ matrix.version }}
            PACKAGE_MANAGER=${{ env.PACKAGE_MANAGER }}
            TORCH_BACKEND=${{ matrix.torch_backend || 'cpu' }}

      - name: Build summary
        run: |
          echo "### ${{ matrix.service }} Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | \`${{ github.event.inputs.platforms || env.PLATFORMS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # SECURITY: Scan images
  # ===========================================================================
  security-scan:
    name: Scan ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: needs.build.result == 'success' && github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.services) }}

    permissions:
      security-events: write

    steps:
      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_NAMESPACE }}/${{ matrix.image }}:v${{ matrix.version }}${{ matrix.torch_backend == 'gpu' && '-gpu' || '' }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  notify:
    name: Summary
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manager:** ${{ env.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Strategy:** Unified build (AMD64 by default, ARM64 via QEMU on manual trigger)" >> $GITHUB_STEP_SUMMARY
          echo "**Default Platforms:** ${{ env.PLATFORMS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** ARM64 builds use QEMU emulation and may fail with native binaries like Prisma." >> $GITHUB_STEP_SUMMARY
