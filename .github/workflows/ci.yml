# =============================================================================
# MEESHY - CI Pipeline
# =============================================================================
# Continuous Integration: Lint, Type-check, Test with Coverage, Build
# Optimized for monorepo with Turborepo
# Supports: bun (default) or pnpm
# =============================================================================

name: CI

on:
  push:
    branches: [main, dev, develop]
  pull_request:
    branches: [main, dev, develop]
  workflow_dispatch:
    inputs:
      package_manager:
        description: 'Package manager to use'
        required: false
        type: choice
        default: 'bun'
        options:
          - bun
          - pnpm

env:
  NODE_VERSION: '22'
  BUN_VERSION: '1.1.38'
  PNPM_VERSION: '9'
  PYTHON_VERSION: '3.12'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  # Default to bun, can be overridden by workflow_dispatch
  PACKAGE_MANAGER: ${{ github.event.inputs.package_manager || 'bun' }}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # QUALITY: Lint & Type-check (Fast feedback)
  # ===========================================================================
  quality:
    name: Quality (${{ github.event.inputs.package_manager || 'bun' }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: bun install

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Lint
        run: ${{ env.PACKAGE_MANAGER == 'bun' && 'bun run' || 'pnpm run' }} lint
        continue-on-error: true

      - name: Type-check
        run: ${{ env.PACKAGE_MANAGER == 'bun' && 'bun run' || 'pnpm run' }} type-check
        continue-on-error: true

  # ===========================================================================
  # TEST: Unit Tests with Coverage (Parallel by package)
  # Minimum coverage threshold: 90%
  # ===========================================================================
  test:
    name: Test ${{ matrix.package.name }}
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        package:
          - name: shared
            path: packages/shared
            filter: '@meeshy/shared'
          - name: web
            path: apps/web
            filter: '@meeshy/web'
          - name: gateway
            path: services/gateway
            filter: '@meeshy/gateway'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: bun install

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Run tests with coverage (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: bun run test:coverage --filter=${{ matrix.package.filter }}

      - name: Run tests with coverage (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm run test:coverage --filter=${{ matrix.package.filter }}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./${{ matrix.package.path }}/coverage/lcov.info
          flags: ${{ matrix.package.name }}
          name: ${{ matrix.package.name }}-coverage

  # ===========================================================================
  # TEST: Python Tests with Coverage
  # Minimum coverage threshold: 90%
  # ===========================================================================
  test-python:
    name: Test Python (translator)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (for Prisma)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/translator/requirements.txt

      - name: Install Python dependencies
        run: |
          cd services/translator
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Generate Prisma client (Python)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd services/translator
          prisma generate --schema=../../packages/shared/prisma/schema.prisma

      - name: Run tests with coverage (90% minimum)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd services/translator
          pytest

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: services/translator/coverage.xml
          flags: translator
          name: translator-coverage

  # ===========================================================================
  # SECURITY: Vulnerability Scan
  # ===========================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # PRISMA: Validate schema and check migrations
  # ===========================================================================
  prisma:
    name: Prisma
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: bun install

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Validate Prisma schema
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma validate

      - name: Check Prisma format
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma format --check || true
        continue-on-error: true

      - name: Generate Prisma client
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma generate

  # ===========================================================================
  # BUILD: Verify builds work (like in Dockerfiles)
  # ===========================================================================
  build:
    name: Build (${{ github.event.inputs.package_manager || 'bun' }})
    runs-on: ubuntu-latest
    needs: [quality, test, prisma]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: bun install

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      # Build shared package (like in Dockerfiles)
      - name: Build shared package (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd packages/shared
          bun run build

      - name: Build shared package (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd packages/shared
          pnpm run build

      # Build gateway (like in Dockerfiles)
      - name: Build gateway (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd services/gateway
          bun run build

      - name: Build gateway (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd services/gateway
          pnpm run build

      # Build web frontend (like in Dockerfiles)
      - name: Build web frontend (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd apps/web
          bun run build

      - name: Build web frontend (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd apps/web
          pnpm run build

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [quality, test, test-python, prisma, security, build]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manager:** ${{ env.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (Node.js) | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (Python) | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prisma | ${{ needs.prisma.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
