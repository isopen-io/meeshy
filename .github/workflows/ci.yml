# =============================================================================
# MEESHY - CI Pipeline
# =============================================================================
# Continuous Integration: Lint, Type-check, Test with Coverage, Build
# Optimized for monorepo with Turborepo
# Supports: bun (default) or pnpm
# =============================================================================

name: CI

on:
  push:
    branches: [main, dev, develop]
  pull_request:
    branches: [main, dev, develop]
  workflow_dispatch:
    inputs:
      package_manager:
        description: 'Package manager to use'
        required: false
        type: choice
        default: 'bun'
        options:
          - bun
          - pnpm
      torch_backend:
        description: 'PyTorch backend (cpu for CI, gpu for production)'
        required: false
        type: choice
        default: 'cpu'
        options:
          - cpu
          - gpu
          - gpu-cu121

env:
  NODE_VERSION: '22'
  BUN_VERSION: '1.1.38'
  PNPM_VERSION: '9'
  # Python 3.10 required: pkuseg (chatterbox-tts dependency) fails to compile on 3.11+
  PYTHON_VERSION: '3.10'
  UV_VERSION: '0.5.x'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  # Default to bun, can be overridden by workflow_dispatch
  PACKAGE_MANAGER: ${{ github.event.inputs.package_manager || 'bun' }}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # QUALITY: Lint & Type-check (Fast feedback)
  # ===========================================================================
  quality:
    name: Quality (${{ github.event.inputs.package_manager || 'bun' }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      # Build shared package first (required for type-check)
      - name: Build shared package (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd packages/shared
          bun run build

      - name: Build shared package (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd packages/shared
          pnpm run build

      - name: Lint
        run: ${{ env.PACKAGE_MANAGER == 'bun' && 'bun run' || 'pnpm run' }} lint
        continue-on-error: true

      - name: Type-check
        run: ${{ env.PACKAGE_MANAGER == 'bun' && 'bun run' || 'pnpm run' }} type-check
        continue-on-error: true

  # ===========================================================================
  # TEST: Unit Tests with Coverage (Parallel by package)
  # Minimum coverage threshold: 90%
  # ===========================================================================
  test:
    name: Test ${{ matrix.package.name }}
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        package:
          - name: shared
            path: packages/shared
            filter: '@meeshy/shared'
          - name: web
            path: apps/web
            filter: '@meeshy/web'
          - name: gateway
            path: services/gateway
            filter: '@meeshy/gateway'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      # Generate Prisma client before building
      - name: Generate Prisma client
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma generate --generator client

      # Build shared package first (required for gateway tests)
      - name: Build shared package (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd packages/shared
          bun run build

      - name: Build shared package (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd packages/shared
          pnpm run build

      - name: Run tests with coverage (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        continue-on-error: ${{ matrix.package.name == 'web' }}
        run: |
          # Web tests must use Jest (configured with Next.js)
          if [ "${{ matrix.package.name }}" = "web" ]; then
            cd ${{ matrix.package.path }}
            echo "Running web tests with Jest via bun..."
            bun run test:coverage
          else
            bun run test:coverage --filter=${{ matrix.package.filter }}
          fi

      - name: Run tests with coverage (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        continue-on-error: ${{ matrix.package.name == 'web' }}
        run: pnpm run test:coverage --filter=${{ matrix.package.filter }}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./${{ matrix.package.path }}/coverage/lcov.info
          flags: ${{ matrix.package.name }}
          name: ${{ matrix.package.name }}-coverage

  # ===========================================================================
  # TEST: Python Tests with Coverage
  # Minimum coverage threshold: 90%
  # Package manager: uv (10-100x faster than pip)
  # ===========================================================================
  test-python:
    name: Test Python (translator)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js and package manager setup for Prisma CLI
      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Install Node.js dependencies (required for Prisma CLI)
      - name: Install Node.js dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install Node.js dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "services/translator/uv.lock"

      - name: Setup Python via uv
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies (ffmpeg + dev libs for PyAV)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg pkg-config \
            libavformat-dev libavcodec-dev libavdevice-dev \
            libavutil-dev libswscale-dev libswresample-dev libavfilter-dev

      - name: Install Python dependencies (CPU backend for CI)
        run: |
          cd services/translator
          uv sync --python ${{ env.PYTHON_VERSION }} --extra cpu --extra dev

      - name: Run tests with coverage (80% minimum)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
          CI: "true"
        timeout-minutes: 30
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} pytest -v --tb=short --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: services/translator/coverage.xml
          flags: translator
          name: translator-coverage

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: translator-test-results
          path: |
            services/translator/coverage.xml
            services/translator/coverage.lcov
          retention-days: 7

  # ===========================================================================
  # TEST: Audio Pipeline with Sample Generation
  # Generates audio samples and uploads as artifacts
  # ===========================================================================
  test-audio-pipeline:
    name: Audio Pipeline Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js and package manager setup for Prisma CLI
      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Install Node.js dependencies (required for Prisma CLI)
      - name: Install Node.js dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install Node.js dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "services/translator/uv.lock"

      - name: Setup Python via uv
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies (ffmpeg + dev libs for PyAV)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 pkg-config \
            libavformat-dev libavcodec-dev libavdevice-dev \
            libavutil-dev libswscale-dev libswresample-dev libavfilter-dev

      - name: Install Python dependencies (CPU backend for CI)
        run: |
          cd services/translator
          uv sync --python ${{ env.PYTHON_VERSION }} --extra cpu --extra dev

      - name: Create audio output directory
        run: |
          mkdir -p services/translator/test_audio_output

      - name: Run audio pipeline tests
        env:
          CI: "true"
          DATABASE_URL: "mongodb://localhost:27017/test"
          AUDIO_OUTPUT_DIR: "test_audio_output"
        timeout-minutes: 15
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m pytest tests/test_11_roundtrip_pipeline.py -v -s --tb=short --no-cov 2>&1 | tee audio_test_output.log

      - name: Generate test report
        if: always()
        run: |
          cd services/translator
          mkdir -p test_audio_output
          echo "# Audio Pipeline Test Report" > test_audio_output/README.md
          echo "" >> test_audio_output/README.md
          echo "Generated on: $(date -u)" >> test_audio_output/README.md
          echo "" >> test_audio_output/README.md
          echo "## Test Results" >> test_audio_output/README.md
          echo '```' >> test_audio_output/README.md
          cat audio_test_output.log >> test_audio_output/README.md || echo "No log available"
          echo '```' >> test_audio_output/README.md
          echo "" >> test_audio_output/README.md
          echo "## Round-Trip Validation" >> test_audio_output/README.md
          echo "- Transcription → Translation → TTS → Re-transcription" >> test_audio_output/README.md
          echo "- **90% minimum word equivalence** validated" >> test_audio_output/README.md

      - name: Upload audio artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audio-pipeline-output
          path: |
            services/translator/test_audio_output/
            services/translator/audio_test_output.log
          retention-days: 30

  # ===========================================================================
  # TEST: TTS/STT Integration Tests
  # Tests UnifiedTTSService, TranscriptionService, and E2E voice pipeline
  # ===========================================================================
  test-tts-stt:
    name: TTS/STT Integration
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js and package manager setup for Prisma CLI
      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Install Node.js dependencies (required for Prisma CLI)
      - name: Install Node.js dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install Node.js dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "services/translator/uv.lock"

      - name: Setup Python via uv
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies (ffmpeg + dev libs for PyAV)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 libsox-dev pkg-config \
            libavformat-dev libavcodec-dev libavdevice-dev \
            libavutil-dev libswscale-dev libswresample-dev libavfilter-dev

      - name: Install Python dependencies (CPU backend for CI)
        run: |
          cd services/translator
          uv sync --python ${{ env.PYTHON_VERSION }} --extra cpu --extra dev

      - name: Generate Prisma client (Python)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m prisma generate --schema=../../packages/shared/prisma/schema.prisma

      - name: Run UnifiedTTSService tests
        env:
          CI: "true"
          DATABASE_URL: "mongodb://localhost:27017/test"
        timeout-minutes: 10
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m pytest tests/test_14_unified_tts_service.py -v --tb=short --no-cov

      - name: Run TranscriptionService tests
        env:
          CI: "true"
          DATABASE_URL: "mongodb://localhost:27017/test"
        timeout-minutes: 10
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m pytest tests/test_06_transcription_service.py -v --tb=short --no-cov

      - name: Run Voice Translation E2E tests
        env:
          CI: "true"
          DATABASE_URL: "mongodb://localhost:27017/test"
        timeout-minutes: 15
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m pytest tests/test_15_voice_translation_e2e.py -v -s --tb=short --no-cov 2>&1 | tee e2e_test_output.log

      - name: Generate E2E report
        if: always()
        run: |
          cd services/translator
          echo "# TTS/STT Integration Test Report" > e2e_report.md
          echo "" >> e2e_report.md
          echo "## Test Summary" >> e2e_report.md
          echo "- UnifiedTTSService: Multi-model TTS with hot-loading" >> e2e_report.md
          echo "- TranscriptionService: Whisper-based STT" >> e2e_report.md
          echo "- Voice Translation E2E: Full pipeline validation" >> e2e_report.md
          echo "" >> e2e_report.md
          echo "## 90% Word Equivalence Requirement" >> e2e_report.md
          echo "The E2E tests validate that:" >> e2e_report.md
          echo "1. Text is translated correctly" >> e2e_report.md
          echo "2. TTS generates intelligible audio" >> e2e_report.md
          echo "3. STT transcription matches translation at 90%+ word overlap" >> e2e_report.md

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tts-stt-test-results
          path: |
            services/translator/e2e_test_output.log
            services/translator/e2e_report.md
          retention-days: 7

  # ===========================================================================
  # TEST: Voice API Tests (Gateway + Translator)
  # Complete coverage for Voice API endpoints and handlers
  # ===========================================================================
  test-voice-api:
    name: Voice API Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "services/translator/uv.lock"

      - name: Setup Python via uv
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install Node.js dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install Node.js dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Install system dependencies (ffmpeg + dev libs for PyAV)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 pkg-config \
            libavformat-dev libavcodec-dev libavdevice-dev \
            libavutil-dev libswscale-dev libswresample-dev libavfilter-dev

      - name: Install Python dependencies (CPU backend for CI)
        run: |
          cd services/translator
          uv sync --python ${{ env.PYTHON_VERSION }} --extra cpu --extra dev

      - name: Generate Prisma client (Python)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m prisma generate --schema=../../packages/shared/prisma/schema.prisma

      # Generate JavaScript Prisma client (required for Gateway Voice API tests)
      - name: Generate Prisma client (JavaScript)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma generate --generator client

      # Build shared package (required for gateway tests)
      - name: Build shared package (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd packages/shared
          bun run build

      - name: Build shared package (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd packages/shared
          pnpm run build

      # Gateway Voice API Tests
      - name: Run Gateway Voice API tests
        run: |
          cd services/gateway
          npm run test -- --testPathPatterns="voice" --passWithNoTests

      # Python Voice API Tests
      - name: Run Python Voice API tests
        env:
          CI: "true"
          DATABASE_URL: "mongodb://localhost:27017/test"
        timeout-minutes: 10
        run: |
          cd services/translator
          uv run --python ${{ env.PYTHON_VERSION }} python -m pytest tests/test_12_voice_api_services.py tests/test_13_voice_api_handler.py -v --tb=short --no-cov

      - name: Upload Voice API test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: voice-api-test-results
          path: |
            services/translator/coverage.xml
            services/translator/coverage.lcov
          retention-days: 7

  # ===========================================================================
  # E2E: Voice Translation Benchmark Tests
  # Comprehensive pipeline tests matching Python XTTS test script
  # ===========================================================================
  test-voice-e2e:
    name: Voice E2E Benchmark
    runs-on: ubuntu-latest
    needs: [quality, test-voice-api]
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[e2e]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Voice E2E Benchmark Tests
        env:
          GATEWAY_URL: ${{ secrets.E2E_GATEWAY_URL || 'http://localhost:3000' }}
          CI: "true"
        timeout-minutes: 30
        run: |
          npx playwright test tests/e2e/voice-translation-benchmark.e2e.test.ts --reporter=list

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: voice-e2e-benchmark-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ===========================================================================
  # SECURITY: Vulnerability Scan
  # ===========================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # PRISMA: Validate schema and check migrations
  # ===========================================================================
  prisma:
    name: Prisma
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      - name: Validate Prisma schema
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma validate

      - name: Check Prisma format
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma format --check || true
        continue-on-error: true

      - name: Generate Prisma client (JavaScript only)
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma generate --generator client

  # ===========================================================================
  # BUILD: Verify builds work (like in Dockerfiles)
  # ===========================================================================
  build:
    name: Build (${{ github.event.inputs.package_manager || 'bun' }})
    runs-on: ubuntu-latest
    needs: [quality, test, prisma]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup bun
        if: env.PACKAGE_MANAGER == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      # pnpm is always needed for turborepo (version from package.json packageManager)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        if: env.PACKAGE_MANAGER == 'pnpm'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Node.js (without cache for bun)
        if: env.PACKAGE_MANAGER == 'bun'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (bun with retry)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          for i in 1 2 3; do
            bun install && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Install dependencies (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: pnpm install --no-frozen-lockfile

      # Generate Prisma client before building
      - name: Generate Prisma client
        env:
          DATABASE_URL: "mongodb://localhost:27017/test"
        run: |
          cd packages/shared
          npx prisma generate --generator client

      # Build shared package (like in Dockerfiles)
      - name: Build shared package (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd packages/shared
          bun run build

      - name: Build shared package (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd packages/shared
          pnpm run build

      # Build gateway (like in Dockerfiles)
      - name: Build gateway (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd services/gateway
          bun run build

      - name: Build gateway (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd services/gateway
          pnpm run build

      # Build web frontend (like in Dockerfiles)
      - name: Build web frontend (bun)
        if: env.PACKAGE_MANAGER == 'bun'
        run: |
          cd apps/web
          bun run build

      - name: Build web frontend (pnpm)
        if: env.PACKAGE_MANAGER == 'pnpm'
        run: |
          cd apps/web
          pnpm run build

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [quality, test, test-python, test-audio-pipeline, test-tts-stt, test-voice-api, test-voice-e2e, prisma, security, build]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Manager:** ${{ env.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (Node.js) | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (Python) | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Audio Pipeline | ${{ needs.test-audio-pipeline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TTS/STT Integration | ${{ needs.test-tts-stt.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Voice API Tests | ${{ needs.test-voice-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Voice E2E Benchmark | ${{ needs.test-voice-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prisma | ${{ needs.prisma.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
